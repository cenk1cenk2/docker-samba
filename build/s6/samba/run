#!/bin/bash

# Treat unset variables as an error
set -o nounset

# SAMBA SCRIPT START
echo "Starting SAMBA/CIFS Server..."
echo "--------------------------------------------------------------------------"

# Create arguments string
# Enable NMBD
ARGUMENTS="-n"
# Server Name
ARGUMENTS="${ARGUMENTS} -g \"netbios name = \"${SRVNAME}\"\""
# Workgroup Name
ARGUMENTS="${ARGUMENTS} -w \"${WORKGROUPNAME}\""
# Parse and split Users by :
while IFS=':' read -ra TEMP; do
    for i in "${TEMP[@]}"; do
        ARGUMENTS="${ARGUMENTS} -u \"${i}\""
    done
done <<< "${USERS}"
# Parse and split Mounts by :
while IFS=':' read -ra TEMP; do
    for i in "${TEMP[@]}"; do
        ARGUMENTS="${ARGUMENTS} -s \"${i}\""
    done
done <<< "${MOUNTS}"

# Call the helper script
eval /s6-bin/samba/entrypoint.sh "${ARGUMENTS}"

while smbclient -L '\\localhost' -U '%' -m SMB3 >& /dev/null;:
do
    echo "--------------------------------------------------------------------------"
    echo "Samba server still running and healthy."
    echo "Sleeping 10 minutes."
    echo "--------------------------------------------------------------------------"
    sleep 600
done
